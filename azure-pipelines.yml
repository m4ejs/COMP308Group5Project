trigger:
  - main

pool:
  name: Default

variables:
  buildConfiguration: 'Release'

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: BuildJob
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
            displayName: 'Install Node.js'

          # Build Client (React)
          - script: |
              cd $(Build.SourcesDirectory)/client
              npm install
              npm run build
            displayName: 'Build Client'

          # Build Server (Node.js API)
          - script: |
              cd $(Build.SourcesDirectory)/server
              npm install --legacy-peer-deps
            displayName: 'Install Server Dependencies'
          
  - stage: SonarQubeAnalysis
    displayName: 'SonarQube Code Analysis'
    jobs:
      - job: SonarJob
        steps:
          - task: SonarQubePrepare@5
            inputs:
              SonarQube: 'Project_SonarCube'
              scannerMode: 'CLI'
              configMode: 'manual'
              cliProjectKey: 'm4ejs_COMP308Group5Project'
              cliProjectName: 'COMP308Group5Project'

          - task: SonarQubeAnalyze@5

          - task: SonarQubePublish@5
            inputs:
              pollingTimeoutSec: '300'

  - stage: Test
    displayName: 'Run Tests & Generate Coverage'
    jobs:
      - job: TestJob
        continueOnError: true
        steps:
          - script: |
              cd $(Build.SourcesDirectory)/server
              npx jest --coverage
            displayName: 'Run Tests & Coverage'

  - stage: Artifact
    displayName: 'Publish Artifact'
    jobs:
      - job: ArtifactJob
        steps:
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'dist'
              ArtifactName: 'drop'

  - stage: DeployDev
    displayName: 'Deploy to Dev Environment'
    jobs:
      - job: DeployJob
        steps:
          - script: |
              echo "Deploying to Dev Environment"
              echo "App running at http://localhost:5000"
            displayName: 'Deployment Simulation'
